### Redis事务
Redis使用 `multi` 命令开启一个事务，使用 `exec` 命令执行一个事务。   

1、事务开始   
`multi` 命令标志着事务的开始，将执行该命令的客户端切换到事务状态，即打开客户端 `flags` 属性中的 `redis_multi` 标识。   
2、命令入队   
当客户端切换到事务状态后，如果后续发送的命令是 `exec`、`discard`、`watch`、`multi` 则立即执行，如果是其它命令则进入事务队列。   
3、执行事务   
当客户端发送 `exec` 命令时，服务端遍历事务队列并执行队列中保存的命令，最后将命令的结果全部返回给客户端。   

### watch 命令
Redis的事务在命令入队过程中，如果其它客户端对事务中的 `key` 进行了操作，即类似于MySQL数据库的“脏读”，此时服务器不应该再执行这个事务。   
Redis可使用 `watch` 命令对 `key` 进行监控，在执行事务时如果发现至少有一个 `key` 被修改过则整个事务不执行。   

1、每个数据库都保存有一个 `watched_keys` 字典，键是被 `watch` 命令监视的数据库键，值则是一个链表保存了所有监视了该键的客户端。   
2、当数据库键被修改后，会去 `watched_keys` 字典中找到监视该键的所有客户端，并将这些客户端的 `redis_dirty_cas` 标识打开表示该客户端的事务安全性已被破坏。   
3、当服务端收到客户端的 `exec` 命令时，则根据该客户端是否打开了 `redis_dirty_cas` 标识来决定是否执行事务。   
