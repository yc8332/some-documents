### RDB方式
RDB文件保存数据库所有的键值对数据在硬盘上，可使用`save`和`bgsave`命令生成RDB文件   
>save 直接阻塞服务器进程，知道RDB文件保存完毕   
>bgsave 派生一个子进程，由子进程创建RDB文件，父进程继续处理客户端请求   

因为bgsave命令不阻塞，可以周期性的调用该命令更新保存RDB文件，触发条件默认配置如下，三组条件已数组形式保存在 `redisServer` 结构的 `saveparams` 属性中：   
>save 900 1       900s内数据库有一次以上修改   
>save 300 10      300s内数据库有十次以上修改   
>save 60  10000   60s内数据库有一万次以上修改   

在 `redisServer` 结构中，`lastsave` 属性保存了RDB文件上次的保存时间，`dirty` 字段保存了上次保存时间到当前时间内数据库所做的修改次数。Redis服务器周期性操作函数 serverCron 默认每隔100ms执行一次，会检查 `lastsave` 和 `dirty` 是否满足 `redisServer.saveparams` 中的条件，如果满足其中任意条件则调用 `bgsave` 命令保存RDB文件   

RDB文件在Redis服务启动时自动载入，服务启动时会检测有无RDB文件，如果服务开启了AOF持久化功能则优先使用AOF文件还原数据库状态，因为AOF文件的更新频率比RDB文件更高   

### AOF方式
AOF文件保存Redis服务器执行的写命令，命令以Redis命令请求协议格式保存(纯文本格式)   
服务启动时，读入AOF文件，将所有写命令执行一遍即可还原数据库状态   

Redis服务进程就是一个事件循环，在一个循环中文件事件负责接收客户端的命令请求以及向客户端发送命令回复。处理文件事件时，如果执行了写命令，会将该写命令追加到 `redisServer.aof_buf` 属性中   
在事件循环结束前，都会调用 `flushAppendOnlyFile` 函数，看是否需要将 `aof_buf` 中的内容写入AOF文件。是否写入由配置文件中的 `appendfsync` 选项决定   
> always 写入AOF文件，每次都同步AOF文件到硬盘   
> everysec 写入AOF文件，每秒同步一次AOF文件到硬盘   
> no 写入AOF文件，文件同步由操作系统决定   

AOF文件重写   
当一个键被多次写时，AOF会记录多条写命令，导致AOF文件过大。Redis提供AOF文件重写功能，创建一个新的AOF文件，原先需要多条写命令才能记录键的状态，现在直接一条写命令记录键的当前状态   
AOF重写由子进程后台执行，此时父进程继续处理命令请求，这会导致数据库当前状态和重写后的AOF文件保存的数据库状态不一致   
因此，Redis服务器设置了一个AOF重写缓冲区，当Redis执行完一个写命令时，不仅仅将写命令追加到aof_buf中，还会将该命令追加到AOF重写缓冲区中供AOF重写子进程读取，这样可保证新AOF文件的数据库状态与服务器当前状态是一致的   
当子进程完成AOF重写工作后，会向父进程发送一个信号。父进程在接收到信号后，会使用新的AOF文件覆盖现有的AOF文件，整个AOF文件重写过程完毕   
